

{% load static %}


<!doctype html>
	<html lang="en">
	  <head>
	    <!-- Required meta tags -->
	    <meta charset="utf-8">
	    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	    <title>base template</title>
	    {% include 'base/css.html' %}
	    {% block base_head %}{% endblock %}
	  </head>
	  <body>
	  	{% include 'base/navbar.html' with brand_name='eCommerce' %}
	  	<div class="container">
	  	{% block content %} {% endblock %}
	  </div>
	   
	    {% include 'base/js.html' %}

	    <script type="text/javascript">
	    	$(document).ready(function()
	    	{
	    		var productForm = $(".form-product-ajax")
	    		productForm.submit(function(event)
	    		{
	    			event.preventDefault();
	    			//console.log("Form is not sent")
	    			var thisform = $(this)
	    			//var actionEnd = thisform.attr("action");
	    			var actionEnd = thisform.attr("data-endpoint");// API EndPoint
	    			var method = thisform.attr("method");
	    			var formData = thisform.serialize();

	    			//console.log(thisform.attr("action"), thisform.attr("method"), thisform.attr("action"))

	    			$.ajax({
	    				url: actionEnd,
	    				method: method,
	    				data: formData,
	    				success: function(data){
	    					// console.log("success")
	    				 //    console.log(data)
	    				 //    console.log("Added", data.added)
	    				 //    console.log("Removed", data.removed)
	    				    var submitSapn = thisform.find('.submit-span')
	    				    if (data.added){
	    				    	submitSapn.html("In cart <button type='submit' class='btn btn-link'>Remove?</button>")
	    				    }
	    				    else
	    				    {
	    				    	submitSapn.html("<button type='submit' class='btn btn-success'>Add to cart</button>")
	    				    }
	    				    var navbar = $(".navbar-cart-count")
	    				    navbar.text(data.cartItemCount)

	    				    var currentPath = window.location.href //checks for word in the path
	    				    if (currentPath.indexOf("cart") != 1)
	    				    {
	    				    	refreshCart()
	    				    }
	    				},
	    				error: function(errorData){
	    					console.log("error")
	    					console.log(errorData)
	    				}
	    			})
	    		})
	    		function refreshCart(){
	    			console.log("in current cart")
	    			var cartTable = $(".cart-table")
	    			var cartBody = cartTable.find(".cart-body")
	    			//cartBody.html("<h1>Changed</h1>")
	    			var productRows = cartBody.find(".cart-product")

	    			var currentUrl = window.location.href

	    			var refreshCartactUrl = '/api/cart/'
	    			var refreshCartmethod = "GET";
	    			var data = {};

	    			$.ajax({
	    				url: refreshCartactUrl,
	    				method: refreshCartmethod,
	    				data: data,
	    				success: function(data){
	    					console.log("success")
	    					console.log(data)
	    					if(data.products.length > 0)
	    					{
	    						productRows.html(" ");
	    						i = data.products.length
	    						$.each(data.products, function(index,value)
	    						{
	    							console.log(value)
	    							cartBody.prepend("<tr><th scope=\"row\">" + i + "</th><td><a href='" + value.url + "'>" + value.name + "</a></td><td>" + value.price + "</td></tr>")	
	    							i --
	    						})

	    						
	    						cartBody.find(".cart-subtotal").text(data.subtotal)
	    						cartBody.find(".cart-total").text(data.total)
	    					}
	    					else
	    					{
	    						window.location.href = currentUrl
	    					}
	    				},
	    				error: function(errorData){
	    					console.log("error")
	    					console.log(errorData)
	    				}
	    			})
	    		}
	    	})
	    </script>
	  </body>
	</html>